/**
 * Sample k6 script generated by System Design Playground
 * This is an example of what the exportToK6 function generates
 */

import http from 'k6/http';
import { check, sleep } from 'k6';
import { Rate, Trend } from 'k6/metrics';

// Custom metrics
const errorRate = new Rate('errors');
const successRate = new Rate('success');
const customLatency = new Trend('custom_latency');

// Test configuration
export const options = {
  "vus": 150,
  "duration": "60s",
  "thresholds": {
    "http_req_duration": [
      "p(95)<50"
    ],
    "http_req_failed": [
      "rate<0.01"
    ],
    "http_reqs": [
      "rate>=900"
    ]
  }
};

// Test endpoints with weights
const endpoints = [
  {
    "id": "entry-1",
    "name": "User Requests",
    "method": "GET",
    "url": "https://api.myapp.com/users",
    "headers": {
      "Content-Type": "application/json",
      "User-Agent": "k6-load-test"
    },
    "weight": 1000
  },
  {
    "id": "gateway-1",
    "name": "API Gateway",
    "method": "POST",
    "url": "https://gateway.myapp.com/api/v1/process",
    "headers": {
      "Authorization": "Bearer token",
      "Content-Type": "application/json"
    },
    "body": {
      "action": "{{$randomInt}}",
      "timestamp": "{{$timestamp}}"
    },
    "weight": 5000
  }
];

// Helper: Replace template variables
function replaceVariables(obj) {
  if (typeof obj === 'string') {
    return obj
      .replace('{{$randomInt}}', Math.floor(Math.random() * 1000000))
      .replace('{{$timestamp}}', Date.now())
      .replace('{{$uuid}}', generateUUID());
  }
  if (typeof obj === 'object' && obj !== null) {
    return Object.fromEntries(
      Object.entries(obj).map(([k, v]) => [k, replaceVariables(v)])
    );
  }
  return obj;
}

// Simple UUID generator
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

/**
 * Main test function - executed by each VU
 */
export default function () {
  // Weighted random endpoint selection
  const rand = Math.random() * 6000;
  let cumWeight = 0;
  let endpoint = endpoints[0];
  
  for (const ep of endpoints) {
    cumWeight += ep.weight;
    if (rand <= cumWeight) {
      endpoint = ep;
      break;
    }
  }
  
  // Prepare request parameters
  const params = {
    headers: endpoint.headers || {},
    timeout: '30s',
    tags: { 
      endpoint: endpoint.name,
      method: endpoint.method 
    },
  };
  
  // Prepare request body with variable replacement
  const requestBody = endpoint.body 
    ? JSON.stringify(replaceVariables(endpoint.body)) 
    : null;
  
  // Execute request
  const startTime = Date.now();
  let response;
  
  switch (endpoint.method) {
    case 'POST':
      response = http.post(endpoint.url, requestBody, params);
      break;
    case 'PUT':
      response = http.put(endpoint.url, requestBody, params);
      break;
    case 'PATCH':
      response = http.patch(endpoint.url, requestBody, params);
      break;
    case 'DELETE':
      response = http.del(endpoint.url, params);
      break;
    default:
      response = http.get(endpoint.url, params);
  }
  
  const duration = Date.now() - startTime;
  customLatency.add(duration);
  
  // Assertions
  const success = check(response, {
    'status is 2xx': (r) => r.status >= 200 && r.status < 300,
    'response time OK': (r) => r.timings.duration < 50,
    'has response body': (r) => r.body && r.body.length > 0,
  });
  
  // Record metrics
  errorRate.add(!success);
  successRate.add(success);
  
  // Log errors for debugging
  if (!success) {
    console.error(`[${endpoint.name}] Failed: ${response.status} - ${response.body?.substring(0, 100)}`);
  }
  
  // Think time (simulate user behavior)
  sleep(Math.random() * 2 + 1); // 1-3 seconds
}

/**
 * Setup function - runs once before test
 */
export function setup() {
  console.log('Starting load test...');
  console.log(`Total endpoints: ${endpoints.length}`);
  console.log(`Target VUs: ${options.vus || 'N/A'}`);
  console.log(`Duration: ${options.duration || 'stages-based'}`);
  return { startTime: Date.now() };
}

/**
 * Teardown function - runs once after test
 */
export function teardown(data) {
  const duration = (Date.now() - data.startTime) / 1000;
  console.log(`Test completed in ${duration.toFixed(2)} seconds`);
}
